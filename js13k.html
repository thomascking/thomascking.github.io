<!DOCTYPE html>
<html style="padding: 0; margin: 0;">
    <body style="padding: 0; margin: 0; max-height: 100vh;">
        <svg viewBox="0 0 1000 1000" style="background: black; max-height: 100vh; max-width: 100vh;">
            <defs>
                <filter id="blurMe" x="-50%" y="-50%" width="200%" height="200%">
                    <feTurbulence type="fractalNoise" seed="1" baseFrequency=".25" numOctaves="2"/>
                    <feOffset>
                        <animate attributeName="dx" values="-10;10;-10" dur="2s" repeatCount="indefinite"/>
                        <animate attributeName="dy" values="-10;10;-10" dur="3s" repeatCount="indefinite"/>
                    </feOffset>

                    <feDisplacementMap in="SourceGraphic" xChannelSelector="R" yChannelSelector="G" scale="20" result="star"/>

                    <feTurbulence baseFrequency="0.04"/>

                    <feDiffuseLighting in="noise" lighting-color="white">
                        <feDistantLight azimuth="45" elevation="60" />
                        <animate attributeName="surfaceScale" values="0;6;0" dur="5s" repeatCount="indefinite"/>
                    </feDiffuseLighting>
                    <feOffset result="light">
                        <animate attributeName="dx" values="-50;50;-50" dur="23s" repeatCount="indefinite"/>
                        <animate attributeName="dy" values="-50;50;-50" dur="37s" repeatCount="indefinite"/>
                    </feOffset>

                    <feComposite in="star" in2="light" operator="arithmetic" k1="1" k2="0" k3="0" k4="0"/>

                    <feGaussianBlur stdDeviation="1"/>
                    <feComponentTransfer>
                        <feFuncA type="linear" slope="1" intercept="0.5"/>
                    </feComponentTransfer>
                    <feGaussianBlur stdDeviation="3"/>
                </filter>

                <filter id="lighting" x="-100" y="-100" width="200" height="200">
                    <feOffset id="lightTrans" result="translated" dx="500" dy="500"/>

                    <feDiffuseLighting id="lastLight" lighting-color="#fff">
                        <feDistantLight>
                    </feDiffuseLighting>

                    <!-- <feSpecularLighting result="light0" in="translated" specularExponent="15" surfaceScale="15" lighting-color="red">
                        <fePointLight x="0" y="0" z="200"/>
                    </feSpecularLighting>
                    <feComposite in="out0" in2="light0" result="out1" operator="arithmetic" k1="1" k2="1" k3="1" k4="0" />

                    <feSpecularLighting result="light1" in="translated" specularExponent="15" surfaceScale="15" lighting-color="white">
                        <fePointLight x="500" y="900" z="200"/>
                    </feSpecularLighting>
                    <feComposite in="out1" in2="light1" result="out2" operator="arithmetic" k1="1" k2="1" k3="1" k4="0" />

                    <feSpecularLighting result="light2" in="translated" specularExponent="15" surfaceScale="15" lighting-color="yellow">
                        <fePointLight x="1000" y="200" z="200"/>
                    </feSpecularLighting>
                    <feComposite in="out2" in2="light2" operator="arithmetic" k1="1" k2="1" k3="1" k4="0" /> -->

                    <feGaussianBlur stdDeviation="4"/>

                    <feComposite in2="translated" operator="arithmetic" k1="1" k2="0" k3="0" k4="0" />
                    <feOffset id="lightTrans2" dx="-500" dy="-500"/>
                </filter>

                <linearGradient id="shipGradient">
                    <stop offset="0" stop-color="#fff" stop-opacity=".75" />
                    <stop offset="40%" stop-color="#bfbfbf" stop-opacity=".99" />
                    <stop offset="50%" stop-color="#bbb" stop-opacity="1" />
                    <stop offset="60%" stop-color="#bfbfbf" stop-opacity=".99" />
                    <stop offset="100%" stop-color="#fff" stop-opacity=".75" />
                </linearGradient>
            </defs>

            <g id="stars"></g>

            <g transform="translate(500 500)" filter="url(#lighting)">
                <g id="ship">
                    <path d="M -15 20 
                            Q -14 8 -8 8 
                            Q -16 -4 0 -20 
                            Q 16 -4 8 8
                            Q 14 8 15 20
                            Q 0 10 -15 20" fill="url(#shipGradient)"/>
                </g>
            </g>

            <text id="spedometer" fill="white" x="10" y="15"></text>
        </svg>
        <script>
            let angle = 0;
            let angularV = 0;

            let x = 500;
            let y = 500;
            let vX = 0;
            let vY = 0;

            let thrust = 0;
            let turn = 0;

            let raf = 0;

            window.onkeydown = event => {
                switch(event.key) {
                    case "Enter":
                        if (!raf) startGame();
                        break;
                    case " ":
                        thrust = 1;
                        break;
                    case "ArrowLeft":
                        turn = -1;
                        break;
                    case "ArrowRight":
                        turn = 1;
                        break;
                }
            };

            window.onkeyup = event => {
                switch(event.key) {
                    case " ":
                        thrust = 0;
                        break;
                    case "ArrowLeft":
                    case "ArrowRight":
                        turn = 0;
                        angularV = 0;
                        break;
                }
            };

            const starG = document.getElementById('stars');
            const shipG = document.getElementById('ship');

            const lightTrans = document.getElementById('lightTrans');
            const lightTrans2 = document.getElementById('lightTrans2');

            const spedometer = document.getElementById('spedometer');

            let lastLight = document.getElementById('lastLight')

            const stars = [];

            const addStar = (x, y, size, density) => {
                const color = `#f${Math.min(15, Math.floor((density - .5) * 64)).toString(16)}${Math.max(0, Math.floor((density - .75) * 63)).toString(16)}`;
                const newStar = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                newStar.setAttribute('fill', color);
                newStar.setAttribute('transform', `translate(${x} ${y}) scale(${size})`);
                newStar.setAttribute('r', '50');
                newStar.setAttribute('filter', 'url(#blurMe)');
                starG.appendChild(newStar);

                const name = `light${stars.length}`;
                const previousName = `out${stars.length}`;
                const newLight = document.createElementNS('http://www.w3.org/2000/svg', 'feSpecularLighting');
                newLight.setAttribute('in', 'translated');
                newLight.setAttribute('specularExponent', '20');
                newLight.setAttribute('surfaceScale', '15');
                newLight.setAttribute('lighting-color', color);
                const newPoint = document.createElementNS('http://www.w3.org/2000/svg', 'fePointLight');
                newPoint.setAttribute('x', `${x}`);
                newPoint.setAttribute('y', `${y}`);
                newPoint.setAttribute('z', '200');
                newLight.appendChild(newPoint);
                const newComposite = document.createElementNS('http://www.w3.org/2000/svg', 'feComposite');
                newComposite.setAttribute('in', previousName);
                newComposite.setAttribute('in2', name);
                newComposite.setAttribute('operator', 'arithmetic');
                newComposite.setAttribute('k1', '1');
                newComposite.setAttribute('k2', '1');
                newComposite.setAttribute('k3', '1');
                newComposite.setAttribute('k4', '0');

                lastLight.setAttribute('result', previousName);
                lastLight.after(newLight, newComposite);
                lastLight = newComposite;

                stars.push({x,y,size,density});
            };

            addStar(0, 0, 1.5, .5);
            addStar(1000, 200, .75, .75);
            addStar(500, 900, .5, 1);

            let previous;

            const frame = () => {
                raf = requestAnimationFrame(frame);

                let now = performance.now();
                let elapsed = now - previous;
                previous = now;

                let rA = angle * Math.PI / 180;

                vX -= vX * .0125;
                vY -= vY * .0125;

                for (let star of stars) {
                    const dx = x - star.x;
                    const dy = y - star.y;
                    const d = Math.sqrt(dx*dx+dy*dy);
                    if (d < star.size * 50) endGame();
                    const dir = Math.atan2(dx, dy);
                    const force = 20 * star.size * star.density / (d*d);
                    vY += force * elapsed * Math.cos(dir);
                    vX += force * elapsed * Math.sin(dir);
                }

                vY += thrust * .000275 * elapsed * Math.cos(rA);
                vX += thrust * .000275 * elapsed * -Math.sin(rA);
                let speed = Math.sqrt(vX*vX + vY*vY);
                while (speed > 1) {
                    vX *= .99;
                    vY *= .99;
                    speed = Math.sqrt(vX*vX + vY*vY);
                }

                x += -vX * elapsed;
                y += -vY * elapsed;

                angularV += turn * .0025 * elapsed;
                if (angularV > .5) angularV = .5;
                if (angularV < -.5) angularV = -.5;
                angle += angularV * elapsed;

                starG.setAttribute('transform', `translate(${500-x} ${500-y})`);
                shipG.setAttribute('transform', `rotate(${angle})`);
                spedometer.innerHTML = `${Math.round(speed * 100)}`;

                lightTrans.setAttribute('dx', `${x}`);
                lightTrans.setAttribute('dy', `${y}`);
                lightTrans2.setAttribute('dx', `${-x}`);
                lightTrans2.setAttribute('dy', `${-y}`);
            };

            const startGame = () => {
                x = 500;
                y = 500;
                vX = 0;
                vY = 0;
                angularV = 0;
                angle = 0;
                thrust = 0;
                turn = 0;
                previous = performance.now();
                frame();
            };

            const endGame = () => {
                cancelAnimationFrame(raf);
                raf = 0;
            };

        </script>
    </body>
</html>
